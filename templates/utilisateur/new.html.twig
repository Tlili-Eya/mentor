<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvel Utilisateur</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

{% block body %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{{ path('app_utilisateur_index') }}">Utilisateurs</a></li>
                    <li class="breadcrumb-item active">Nouveau</li>
                </ol>
            </nav>
            <h2 class="fw-bold text-dark mb-0">
                <i class="fas fa-user-plus me-2 text-success"></i>
                Cr√©er un nouvel utilisateur
            </h2>
            <p class="text-muted mt-2 mb-0">Remplissez le formulaire pour ajouter un nouveau membre √† votre √©quipe</p>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card profile-preview border-0 shadow-modern rounded-4 overflow-hidden sticky-top" style="top: 2rem;">
                <div class="profile-header">
                    <div class="profile-bg"></div>
                    <div class="profile-avatar-container">
                        <div class="profile-avatar profile-avatar-placeholder" id="avatarPreview">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="new-user-badge">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="card-body text-center pt-5 pb-4">
                    <h5 class="fw-bold mb-1" id="namePreview">Nouveau Utilisateur</h5>
                    <p class="text-muted mb-3" id="emailPreview">email@exemple.com</p>
                    <div class="info-badge">
                        <i class="fas fa-eye me-2"></i>
                        Aper√ßu en direct
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-modern rounded-4 overflow-hidden">
                <div class="card-header bg-gradient-modern border-0 p-4">
                    <h5 class="mb-0 fw-semibold text-white">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Informations du nouvel utilisateur
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    {{ form_start(form, {'attr': {'class': 'modern-form', 'id': 'newUserForm'}}) }}
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label class="form-label-modern required">
                                    <i class="fas fa-user me-2"></i>Pr√©nom<span class="required-star">*</span>
                                </label>
                                {{ form_widget(form.prenom, {'attr': {'class': 'form-control-modern', 'placeholder': 'Entrez le pr√©nom', 'onkeyup': 'updatePreview()', 'required': true}}) }}
                                {{ form_errors(form.prenom) }}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label class="form-label-modern required">
                                    <i class="fas fa-user-tag me-2"></i>Nom<span class="required-star">*</span>
                                </label>
                                {{ form_widget(form.nom, {'attr': {'class': 'form-control-modern', 'placeholder': 'Entrez le nom', 'onkeyup': 'updatePreview()', 'required': true}}) }}
                                {{ form_errors(form.nom) }}
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-group-modern">
                                <label class="form-label-modern required">
                                    <i class="fas fa-envelope me-2"></i>Adresse email<span class="required-star">*</span>
                                </label>
                                {{ form_widget(form.email, {'attr': {'class': 'form-control-modern', 'placeholder': 'exemple@email.com', 'onkeyup': 'updatePreview()', 'required': true, 'type': 'email'}}) }}
                                {{ form_errors(form.email) }}
                                <small class="form-text text-muted d-block mt-2">
                                    <i class="fas fa-info-circle me-1"></i>L'email sera utilis√© pour la connexion
                                </small>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-group-modern">
                                <label class="form-label-modern required">
                                    <i class="fas fa-lock me-2"></i>Mot de passe<span class="required-star">*</span>
                                </label>
                                <div class="password-input-wrapper">
                                    {{ form_widget(form.mdp, {'attr': {'class': 'form-control-modern', 'placeholder': 'Minimum 8 caract√®res', 'required': true, 'id': 'passwordInput'}}) }}
                                    <button type="button" class="password-toggle" onclick="togglePassword()">
                                        <i class="fas fa-eye" id="toggleIcon"></i>
                                    </button>
                                </div>
                                {{ form_errors(form.mdp) }}
                                <div class="password-strength mt-3">
                                    <div class="strength-bar">
                                        <div class="strength-fill" id="strengthBar"></div>
                                    </div>
                                    <small class="strength-text" id="strengthText">Force du mot de passe</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label class="form-label-modern required">
                                    <i class="fas fa-user-shield me-2"></i>R√¥le<span class="required-star">*</span>
                                </label>
                                {{ form_widget(form.role, {'attr': {'class': 'form-control-modern form-select-modern', 'required': true}}) }}
                                {{ form_errors(form.role) }}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group-modern">
                                <label class="form-label-modern">
                                    <i class="fas fa-calendar-check me-2"></i>Date d'inscription
                                    <span class="badge bg-info-subtle text-info ms-2">Auto</span>
                                </label>
                                {{ form_widget(form.date_inscription, {'attr': {'class': 'form-control-modern'}}) }}
                                {{ form_errors(form.date_inscription) }}
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-group-modern">
                                <label class="form-label-modern">
                                    <i class="fas fa-image me-2"></i>URL de la photo de profil
                                    <span class="badge bg-secondary-subtle text-secondary ms-2">Optionnel</span>
                                </label>
                                {{ form_widget(form.pdp_url, {'attr': {'class': 'form-control-modern', 'placeholder': 'photo.jpg ou laissez vide'}}) }}
                                {{ form_errors(form.pdp_url) }}
                            </div>
                        </div>
                    </div>

                    {{ form_rest(form) }}

                    <div class="form-actions mt-5">
                        <input type="hidden" name="submission_secret" id="submissionSecret" value="">
                        <button type="submit" onclick="document.getElementById('submissionSecret').value='STRICT_MANUAL_v4_GOLD'" class="btn-create-action">
                            <i class="fas fa-user-plus"></i>
                            <span>Cr√©er l'utilisateur</span>
                        </button>
                        
                        <a href="{{ path('connect_google_register') }}" class="btn-google-action">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google Logo" style="width: 28px; height: 28px;">
                            <span>S'inscrire avec Google</span>
                        </a>

                        <button type="reset" class="btn-reset-action" onclick="resetForm()">
                            <i class="fas fa-redo"></i>
                            <span>Tout effacer</span>
                        </button>
                    </div>

                    {{ form_end(form) }}

                    <!-- ‚úÖ SECTION PASSKEY SORTIE DU FORMULAIRE POUR √âVITER TOUTE PERSISTANCE ACCIDENTELLE -->
                    <div class="mt-4 pt-4 border-top">
                        <p class="text-center text-muted mb-3"><i class="fas fa-shield-alt me-2"></i>OU utilisez la s√©curit√© biom√©trique</p>
                        <button type="button" id="passkeyRegisterBtn" onclick="preparePasskeyRegister(event)" class="btn-create-action w-100" style="background: linear-gradient(135deg, #0a3d62, #102c59); border-color: #102c59; display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 15px; padding: 1.2rem;">
                            <i class="fas fa-fingerprint" style="font-size: 2rem;"></i>
                            <span style="font-size: 1.1rem;">S'inscrire avec Face ID / Passkey</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-modern rounded-4 overflow-hidden mt-4">
                <div class="card-body p-4">
                    <h6 class="fw-semibold mb-3">
                        <i class="fas fa-shield-alt text-success me-2"></i>Conseils de s√©curit√©
                    </h6>
                    <div class="security-tips">
                        <div class="tip-item">
                            <i class="fas fa-key text-warning"></i>
                            <div>
                                <strong>Mot de passe fort</strong>
                                <p>Utilisez au minimum 8 caract√®res avec majuscules, minuscules et chiffres</p>
                            </div>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-user-lock text-primary"></i>
                            <div>
                                <strong>R√¥le appropri√©</strong>
                                <p>Attribuez uniquement les permissions n√©cessaires √† l'utilisateur</p>
                            </div>
                        </div>
                        <div class="tip-item">
                            <i class="fas fa-envelope-open-text text-info"></i>
                            <div>
                                <strong>Email valide</strong>
                                <p>Assurez-vous que l'email est correct pour les notifications</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL QR REGISTER -->
<div id="qrRegisterModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:30px; border-radius:20px; text-align:center; max-width:350px;">
        <h3 style="color:#102c59; margin-bottom:15px;">üì± Scannez avec votre t√©l√©phone</h3>
        <img id="qrRegisterImage" src="" style="width:250px; height:250px; border-radius:10px;">
        <p style="color:#666; margin-top:15px; font-size:0.9rem;">Puis enregistrez votre visage sur votre t√©l√©phone</p>
        <p id="qrRegisterStatus" style="color:#102c59; font-weight:600; margin-top:10px;">‚è≥ En attente...</p>
        <button onclick="closeRegisterQR()" style="margin-top:15px; padding:10px 25px; background:#d52e28; color:white; border:none; border-radius:10px; cursor:pointer;">Annuler</button>
    </div>
</div>

<style>
    :root {
        --primary-color: #6366f1;
        --success-color: #7A9AAD;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1f2937;
        --light-color: #f9fafb;
        --border-color: #e5e7eb;
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8edf2 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        min-height: 100vh;
    }

    .shadow-modern { box-shadow: 0 4px 20px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.02); }
    .breadcrumb { background: none; padding: 0; margin: 0; }
    .breadcrumb-item a { color: #6b7280; text-decoration: none; }
    .breadcrumb-item.active { color: var(--dark-color); font-weight: 600; }
    .bg-gradient-modern { background: linear-gradient(135deg, var(--success-color), #059669); }

    .profile-preview { position: relative; }
    .profile-header { position: relative; height: 120px; }
    .profile-bg { position: absolute; top: 0; left: 0; right: 0; height: 120px; background: linear-gradient(135deg, var(--success-color) 0%, #7A9AAD 100%); }
    .profile-avatar-container { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); }
    .profile-avatar { width: 100px; height: 100px; border-radius: 20px; border: 4px solid white; box-shadow: 0 8px 24px rgba(0,0,0,0.15); object-fit: cover; }
    .profile-avatar-placeholder { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
    .new-user-badge { position: absolute; bottom: -5px; right: -5px; width: 32px; height: 32px; background: var(--success-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; }
    .info-badge { display: inline-flex; align-items: center; padding: 0.5rem 1rem; background: rgba(16,185,129,0.1); color: var(--success-color); border-radius: 10px; font-size: 0.8125rem; font-weight: 600; }

    .form-group-modern { margin-bottom: 0; }
    .form-label-modern { display: flex; align-items: center; font-weight: 600; color: var(--dark-color); margin-bottom: 0.75rem; font-size: 0.9375rem; }
    .required-star { color: var(--danger-color); margin-left: 0.25rem; }
    .form-control-modern, .form-select-modern { padding: 0.875rem 1.25rem; border: 2px solid var(--border-color); border-radius: 12px; font-size: 0.9375rem; transition: all 0.3s ease; background: white; width: 100%; }
    .form-control-modern:focus, .form-select-modern:focus { border-color: var(--success-color); box-shadow: 0 0 0 4px rgba(16,185,129,0.1); outline: none; }
    .password-input-wrapper { position: relative; }
    .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.5rem; }
    .strength-bar { height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
    .strength-fill { height: 100%; width: 0%; border-radius: 10px; transition: all 0.3s ease; }
    .strength-text { display: block; margin-top: 0.5rem; font-weight: 600; font-size: 0.8125rem; }

    .form-actions { display: flex; gap: 1rem; padding-top: 2rem; border-top: 2px dashed var(--border-color); flex-wrap: wrap; }

    .btn-create-action, .btn-reset-action {
        flex: 1; min-width: 180px; display: flex; flex-direction: column; align-items: center;
        gap: 0.5rem; padding: 1.5rem; border-radius: 16px; border: 2px solid; cursor: pointer;
        transition: all 0.3s ease; text-decoration: none; font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .btn-create-action i, .btn-reset-action i { font-size: 2.25rem; transition: all 0.3s ease; }
    .btn-create-action { background: linear-gradient(135deg, var(--success-color), #7A9AAD); color: white; border-color: var(--success-color); }
    .btn-create-action:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 20px 40px rgba(16,185,129,0.4); }
    .btn-reset-action { background: rgba(239,68,68,0.1); color: var(--danger-color); border-color: rgba(239,68,68,0.3); }
    .btn-reset-action:hover { background: linear-gradient(135deg, var(--danger-color), #dc2626); color: white; border-color: var(--danger-color); transform: translateY(-6px); }

    .btn-google-action {
        flex: 1; min-width: 180px; display: flex; flex-direction: column; align-items: center;
        gap: 0.5rem; padding: 1.5rem; border-radius: 16px; border: none; cursor: pointer;
        text-decoration: none; font-weight: 600;
        background: linear-gradient(135deg, #102c59 0%, #0a1a36 100%);
        color: white; transition: all 0.3s ease;
    }
    .btn-google-action:hover { background: linear-gradient(135deg, #0a1a36 0%, #102c59 100%); color: white; transform: translateY(-2px); }
    .btn-google-action img { background-color: white; border-radius: 50%; padding: 2px; }

    .security-tips { display: flex; flex-direction: column; gap: 1.25rem; }
    .tip-item { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--light-color); border-radius: 12px; border-left: 4px solid var(--success-color); }
    .tip-item i { font-size: 1.5rem; margin-top: 0.25rem; flex-shrink: 0; }
    .tip-item strong { display: block; color: var(--dark-color); margin-bottom: 0.25rem; }
    .tip-item p { margin: 0; color: #6b7280; font-size: 0.875rem; }

    @media (max-width: 768px) {
        .form-actions { flex-direction: column; }
        .btn-create-action, .btn-reset-action, .btn-google-action { min-width: 100%; }
    }
</style>

<script>
    let registerInterval;

    // ‚úÖ FONCTION PASSKEY CORRIGEE
    async function preparePasskeyRegister(event) {
        event.preventDefault();
        
        const nom = document.querySelector('input[name*="nom"]')?.value;
        const prenom = document.querySelector('input[name*="prenom"]')?.value;
        const email = document.querySelector('input[name*="email"]')?.value;
        const mdp = document.getElementById('passwordInput')?.value;
        const role = document.querySelector('select[name*="role"]')?.value;

        if (!nom || !prenom || !email || !role) {
            alert('‚ö†Ô∏è Remplissez d\'abord tous les champs (nom, pr√©nom, email, r√¥le) !');
            return;
        }

        const res = await fetch('/webauthn/register/qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nom, prenom, email, mdp, role })
        });

        if (!res.ok) {
            const errData = await res.json();
            alert('‚ùå Erreur : ' + (errData.message || 'Impossible de g√©n√©rer le QR code'));
            return;
        }

        const blob = await res.blob();
        document.getElementById('qrRegisterImage').src = URL.createObjectURL(blob);
        document.getElementById('qrRegisterModal').style.display = 'flex';
        document.getElementById('qrRegisterStatus').textContent = '‚è≥ En attente...';

        registerInterval = setInterval(async () => {
            const statusRes = await fetch('/webauthn/register/status');
            const data = await statusRes.json();
            if (data.status === 'confirmed') {
                clearInterval(registerInterval);
                document.getElementById('qrRegisterStatus').textContent = '‚úÖ Compte cr√©√© !';
                setTimeout(() => window.location.href = '/utilisateur/profil', 1000);
            }
        }, 2000);
    }

    function closeRegisterQR() {
        clearInterval(registerInterval);
        document.getElementById('qrRegisterModal').style.display = 'none';
    }

    function updatePreview() {
        const prenom = document.querySelector('input[name*="prenom"]')?.value || '';
        const nom = document.querySelector('input[name*="nom"]')?.value || '';
        const email = document.querySelector('input[name*="email"]')?.value || '';
        const namePreview = document.getElementById('namePreview');
        const emailPreview = document.getElementById('emailPreview');
        if (namePreview) namePreview.textContent = `${prenom} ${nom}`.trim() || 'Nouveau Utilisateur';
        if (emailPreview) emailPreview.textContent = email || 'email@exemple.com';
    }

    function togglePassword() {
        const passwordInput = document.getElementById('passwordInput');
        const toggleIcon = document.getElementById('toggleIcon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function checkPasswordStrength(password) {
        let strength = 0;
        if (password.length >= 8) strength += 25;
        if (password.length >= 12) strength += 25;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 10;
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        strengthBar.style.width = strength + '%';
        if (strength < 40) { strengthBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)'; strengthText.textContent = 'Faible'; strengthText.style.color = '#ef4444'; }
        else if (strength < 70) { strengthBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)'; strengthText.textContent = 'Moyen'; strengthText.style.color = '#f59e0b'; }
        else { strengthBar.style.background = 'linear-gradient(90deg, #10b981, #059669)'; strengthText.textContent = 'Fort'; strengthText.style.color = '#10b981'; }
    }

    function resetForm() {
        setTimeout(() => { updatePreview(); checkPasswordStrength(''); }, 100);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('passwordInput');
        if (passwordInput) {
            passwordInput.addEventListener('keyup', function() { checkPasswordStrength(this.value); });
        }
        updatePreview();

        // ‚úÖ BLOQUER LA SOUMISSION DU FORMULAIRE SI LE SECRET N'EST PAS LE BON
        const form = document.getElementById('newUserForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                const secret = document.getElementById('submissionSecret').value;
                if (secret !== 'STRICT_MANUAL_v4_GOLD' && !e.submitter?.classList.contains('btn-create-action')) {
                    console.log('Submission blocked: Secret missing or wrong button');
                    e.preventDefault();
                    return false;
                }
                console.log('Submission allowed');
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

</body>
</html>
