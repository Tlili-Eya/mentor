{% extends 'front/base.html.twig' %}
{% block title %}Mes Projets - MentorAI{% endblock %}

{% block body %}
<main class="main">
  <div class="page-title" style="background-color: #9dbbce;">
    <div class="container d-lg-flex justify-content-between align-items-center py-4">
      <h1 class="mb-2 mb-lg-0" style="color: #102c59;">Mes Projets</h1>
    </div>
  </div>

  <section class="section" style="background-color: #f8f9fa;">
    <div class="container" data-aos="fade-up" data-aos-delay="100">
      <div class="section-title mb-4">
        <h2 style="color: #102c59; border-bottom: 3px solid #d52e28; padding-bottom: 10px;">Projets de votre compte</h2>
      </div>

      {% if projets is defined and projets|length > 0 %}
        <div class="table-responsive">
          <table class="table table-hover" style="border: 1px solid #dee2e6;">
            <thead class="sticky-top" style="background-color: #102c59; color: white;">
              <tr>
                <th style="border-color: #0d2347;">ID</th>
                <th style="border-color: #0d2347;">Titre</th>
                <th style="border-color: #0d2347;">Type</th>
                <th style="border-color: #0d2347;">Technologies</th>
                <th style="border-color: #0d2347;">Dates</th>
                <th style="border-color: #0d2347;">Ressources</th>
              </tr>
            </thead>
            <tbody>
              {% for projet in projets %}
                <tr style="background-color: white;">
                  <td>{{ projet.id }}</td>
                  <td><strong style="color: #102c59;">{{ projet.titre }}</strong></td>
                  <td><span class="badge" style="background-color: #9dbbce; color: #102c59;">{{ projet.type }}</span></td>
                  <td>{{ projet.technologies }}</td>
                  <td>
                    {% if projet.dateDebut %}
                      <span style="color: #102c59;">{{ projet.dateDebut|date('d/m/Y') }}</span>
                    {% endif %}
                    {% if projet.dateFin %}
                      <span class="text-muted"> → {{ projet.dateFin|date('d/m/Y') }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if projet.ressources|length > 0 %}
                      <button class="btn btn-sm" 
                              data-bs-toggle="collapse" 
                              data-bs-target="#res-{{ projet.id }}"
                              style="background-color: #d52e28; color: white; border-color: #b32420;">
                        <i class="fas fa-file-alt me-1"></i>{{ projet.ressources|length }} ressource(s)
                      </button>
                    {% else %}
                      <span class="badge" style="background-color: #9dbbce; color: #102c59;">0</span>
                    {% endif %}
                  </td>
                </tr>
                {% if projet.ressources|length > 0 %}
                  <tr class="collapse" id="res-{{ projet.id }}">
                    <td colspan="6" class="p-0">
                      <div class="p-4" style="background-color: #f0f4f8;">
                        <h6 style="color: #102c59; border-left: 4px solid #d52e28; padding-left: 10px;">
                          <strong>Ressources pour {{ projet.titre }}</strong>
                        </h6>
                        <div class="row mt-3">
                          {% for r in projet.ressources %}
                            <div class="col-md-6 mb-4">
                              <div class="card h-100 shadow-sm" style="border: 1px solid #9dbbce; border-top: 3px solid #102c59;">
                                <div class="card-body">
                                  <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0" style="color: #102c59;">
                                      <strong>{{ r.nom }}</strong>
                                    </h6>
                                    <span class="badge" style="background-color: #9dbbce; color: #102c59;">
                                      {{ r.typeRessource ? r.typeRessource.name : '' }}
                                    </span>
                                  </div>
                                  
                                  {% if r.description %}
                                    <p class="card-text small mb-3" style="color: #555;">
                                      <i class="fas fa-align-left me-1" style="color: #9dbbce;"></i>
                                      {{ r.description }}
                                    </p>
                                  {% endif %}
                                  
                                  {# Vérifier si c'est une URL YouTube #}
                                  {% if 'youtube.com' in r.urlRessource or 'youtu.be' in r.urlRessource %}
                                    {# Extraire l'ID de la vidéo YouTube #}
                                    {% set youtube_id = null %}
                                    
                                    {# Pattern pour youtube.com/watch?v=VIDEO_ID #}
                                    {% if 'youtube.com/watch?v=' in r.urlRessource %}
                                      {% set youtube_id = r.urlRessource|split('v=')|last|split('&')|first %}
                                    {# Pattern pour youtu.be/VIDEO_ID #}
                                    {% elseif 'youtu.be/' in r.urlRessource %}
                                      {% set youtube_id = r.urlRessource|split('youtu.be/')|last|split('?')|first %}
                                    {# Pattern pour youtube.com/embed/VIDEO_ID #}
                                    {% elseif 'youtube.com/embed/' in r.urlRessource %}
                                      {% set youtube_id = r.urlRessource|split('embed/')|last|split('?')|first %}
                                    {% endif %}
                                    
                                    {# Si on a trouvé un ID YouTube, afficher le lecteur #}
                                    {% if youtube_id %}
                                      <div class="ratio ratio-16x9 mb-3">
                                        <iframe 
                                          src="https://www.youtube.com/embed/{{ youtube_id }}" 
                                          title="YouTube video player" 
                                          frameborder="0" 
                                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                          allowfullscreen>
                                        </iframe>
                                      </div>
                                      <p class="small mb-2">
                                        <i class="fab fa-youtube me-1" style="color: #d52e28;"></i>
                                        <a href="{{ r.urlRessource }}" target="_blank" class="text-decoration-none" style="color: #102c59;">
                                          <strong>Voir sur YouTube</strong>
                                        </a>
                                      </p>
                                    {% else %}
                                      {# Si on ne peut pas extraire l'ID, montrer juste le lien #}
                                      <p class="small mb-2">
                                        <i class="fas fa-link me-1" style="color: #9dbbce;"></i>
                                        <a href="{{ r.urlRessource }}" target="_blank" class="text-decoration-none" style="color: #102c59;">
                                          {{ r.urlRessource|slice(0, 50) }}...
                                        </a>
                                      </p>
                                    {% endif %}
                                  {% else %}
                                    {# Pour les autres types de liens #}
                                    <p class="small mb-2">
                                      <i class="fas fa-link me-1" style="color: #9dbbce;"></i>
                                      <a href="{{ r.urlRessource }}" target="_blank" class="text-decoration-none" style="color: #102c59;">
                                        {{ r.urlRessource|slice(0, 50) }}...
                                      </a>
                                    </p>
                                  {% endif %}
                                  
                                  <div class="small mt-3" style="color: #9dbbce;">
                                    <i class="far fa-calendar me-1"></i>
                                    Ajouté le {{ r.dateCreation ? r.dateCreation|date('d/m/Y') : '' }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert" style="background-color: #9dbbce; border: 1px solid #8aa9c0; color: #102c59;">
          <h4 class="alert-heading" style="color: #102c59;">
            <i class="fas fa-info-circle me-2"></i>Aucun projet trouvé
          </h4>
          <p class="mb-0">Vous n'avez pas encore de projet enregistré.</p>
        </div>
      {% endif %}
    </div>
  </section>
</main>

<style>
  /* Variables pour la charte graphique */
  :root {
    --color-light-blue: #9dbbce;
    --color-dark-blue: #102c59;
    --color-red: #d52e28;
    --color-light-bg: #f8f9fa;
    --color-hover-bg: #f0f4f8;
  }
  
  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .table-hover tbody tr:hover {
    background-color: #f0f4f8 !important;
    transition: background-color 0.3s ease;
  }
  
  .collapse {
    display: table-row;
  }
  
  .collapse:not(.show) {
    display: none;
  }
  
  .ratio-16x9 {
    --bs-aspect-ratio: 56.25%; /* 16:9 aspect ratio */
  }
  
  .card {
    border-radius: 8px;
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(16, 44, 89, 0.1) !important;
    border-color: var(--color-dark-blue) !important;
  }
  
  iframe {
    border-radius: 6px;
    border: 1px solid var(--color-light-blue);
  }
  
  .badge {
    font-weight: 500;
    padding: 0.4em 0.8em;
    border-radius: 4px;
  }
  
  .btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }
  
  /* Animation pour l'ouverture des ressources */
  .collapse.show {
    animation: fadeIn 0.5s ease;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Style pour les liens */
  a[style*="color: #102c59"]:hover {
    color: var(--color-red) !important;
    text-decoration: underline !important;
  }
  
  /* Style pour les bordures du tableau */
  table td, table th {
    padding: 12px 15px;
    vertical-align: middle;
  }
  
  /* Style pour les icônes */
  .fas, .fab, .far {
    transition: color 0.3s ease;
  }
</style>

<script>
// Amélioration pour détecter plus de formats YouTube
function extractYouTubeId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
    /youtube\.com\/v\/([^&\n?#]+)/,
    /youtube\.com\/watch\?.*v=([^&\n?#]+)/,
    /youtu\.be\/([^&\n?#]+)/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }
  return null;
}

// Animation pour les boutons de ressources
document.addEventListener('DOMContentLoaded', function() {
  const resourceButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
  
  resourceButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-bs-target');
      const target = document.querySelector(targetId);
      
      // Changer l'icône du bouton
      const icon = this.querySelector('i');
      if (target.classList.contains('show')) {
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-file-alt');
      } else {
        icon.classList.remove('fa-file-alt');
        icon.classList.add('fa-chevron-up');
      }
    });
  });
  
  // Animation pour les cartes au survol
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-5px)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
});
</script>
{% endblock %}