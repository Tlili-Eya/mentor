{% extends 'front/base.html.twig' %}

{% block title %}Mes Projets - MentorAI{% endblock %}

{% block body %}

<main class="main">

  <!-- Page Title -->
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0">Mes Projets</h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{{ path('front_home') }}">Accueil</a></li>
          <li><a href="{{ path('front_instructors') }}">Projets</a></li>
          <li class="current">Mes Projets</li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- End Page Title -->

  <!-- Projects Listing Section -->
  <section id="projects-listing" class="courses section">

    <div class="container">

      <!-- Stats & Actions -->
      <div class="row mb-5">
        <div class="col-md-8">
          <div class="card bg-light border-0">
            <div class="card-body p-4">
              <div class="row text-center">
                <div class="col-6 col-md-3">
                  <h3 class="text-primary mb-0">{{ totalProjets }}</h3>
                  <small>Projets</small>
                </div>
                <div class="col-6 col-md-3">
                  {% set totalRessources = 0 %}
                  {% for item in projetsAvecRessources %}
                    {% set totalRessources = totalRessources + item.nombreRessources %}
                  {% endfor %}
                  <h3 class="text-success mb-0">{{ totalRessources }}</h3>
                  <small>Ressources</small>
                </div>
                <div class="col-6 col-md-3">
                  <h3 class="text-warning mb-0">
                    {% set projetsActifs = 0 %}
                    {% for item in projetsAvecRessources %}
                      {% if item.projet.dateFin is null or item.projet.dateFin > date('now') %}
                        {% set projetsActifs = projetsActifs + 1 %}
                      {% endif %}
                    {% endfor %}
                    {{ projetsActifs }}
                  </h3>
                  <small>En cours</small>
                </div>
                <div class="col-6 col-md-3">
                  <a href="{{ path('front_instructors') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Nouveau Projet
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Rechercher un projet..." id="search-projects">
            <button class="btn btn-outline-primary" type="button">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Projects Grid -->
      {% if projetsAvecRessources|length > 0 %}
        <div class="row" id="projects-container">
          {% for item in projetsAvecRessources %}
            {% set projet = item.projet %}
            {% set ressources = item.ressources %}
            
            <div class="col-lg-4 col-md-6 d-flex mb-4 project-card" data-project-type="{{ projet.type|lower }}">
              <div class="course-item shadow-sm w-100" data-aos="fade-up">
                
                <!-- Project Header -->
                <div class="course-content p-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h4 class="mb-0">{{ projet.titre }}</h4>
                      <small class="text-muted">
                        <i class="bi bi-calendar"></i>
                        {% if projet.dateDebut %}
                          {{ projet.dateDebut|date('M Y') }}
                        {% endif %}
                        {% if projet.dateFin %}
                          - {{ projet.dateFin|date('M Y') }}
                        {% endif %}
                      </small>
                    </div>
                    <span class="badge bg-{{ getTypeColor(projet.type) }}">{{ projet.type }}</span>
                  </div>

                  <!-- Project Description -->
                  <p class="mb-3">{{ projet.description|slice(0, 120) }}{% if projet.description|length > 120 %}...{% endif %}</p>

                  <!-- Technologies -->
                  <div class="mb-3">
                    <small class="text-muted d-block mb-1">
                      <i class="bi bi-code-slash"></i> Technologies utilis√©es :
                    </small>
                    <div>
                      {% for tech in projet.technologies|split(',')|slice(0, 4) %}
                        <span class="badge bg-light text-dark border me-1 mb-1">{{ tech|trim }}</span>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Resources Preview -->
                  <div class="mb-3">
                    <small class="text-muted d-block mb-2">
                      <i class="bi bi-collection"></i> Ressources ({{ item.nombreRessources }})
                    </small>
                    {% if ressources|length > 0 %}
                      <div class="d-flex flex-wrap gap-2">
                        {% for ressource in ressources|slice(0, 3) %}
                          <span class="badge bg-{{ getResourceTypeColor(ressource.typeRessource) }}">
                            <i class="bi bi-{{ getResourceIcon(ressource.typeRessource) }} me-1"></i>
                            {{ ressource.typeRessource|capitalize }}
                          </span>
                        {% endfor %}
                        {% if ressources|length > 3 %}
                          <span class="badge bg-secondary">+{{ ressources|length - 3 }}</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <small class="text-muted">Aucune ressource</small>
                    {% endif %}
                  </div>

                  <!-- Actions -->
                  <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                    <button class="btn btn-sm btn-outline-primary view-resources" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#resources-{{ projet.id }}">
                      <i class="bi bi-eye"></i> Voir les ressources
                    </button>
                    <small class="text-muted">
                      <i class="bi bi-clock"></i> {{ projet.dateCreation|date('d/m/Y') }}
                    </small>
                  </div>
                </div>

                <!-- Resources Details (Collapsible) -->
                <div class="collapse" id="resources-{{ projet.id }}">
                  <div class="p-4 border-top bg-light">
                    <h6 class="mb-3">üìÇ Toutes les ressources</h6>
                    
                    {% if ressources|length > 0 %}
                      <div class="list-group">
                        {% for ressource in ressources %}
                          <div class="list-group-item border-0 bg-transparent px-0">
                            <div class="d-flex align-items-start">
                              <div class="flex-shrink-0">
                                <i class="bi bi-{{ getResourceIcon(ressource.typeRessource) }} text-{{ getResourceTypeColor(ressource.typeRessource) }} fs-5"></i>
                              </div>
                              <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">{{ ressource.nom }}</h6>
                                <p class="mb-1 small">{{ ressource.description }}</p>
                                <small class="text-muted">
                                  <a href="{{ ressource.urlRessource }}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-link-45deg"></i> {{ ressource.urlRessource|truncate(40) }}
                                  </a>
                                </small>
                              </div>
                              <div class="flex-shrink-0">
                                <small class="text-muted">{{ ressource.dateCreation|date('d/m/Y') }}</small>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> Aucune ressource n'a √©t√© ajout√©e √† ce projet.
                      </div>
                    {% endif %}
                    
                    <div class="mt-3 text-end">
                      <a href="{{ path('front_instructors') }}?edit={{ projet.id }}" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Ajouter une ressource
                      </a>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          {% endfor %}
        </div>

        <!-- No Results Message (hidden by default) -->
        <div id="no-results" class="text-center py-5 d-none">
          <i class="bi bi-search display-1 text-muted mb-3"></i>
          <h4 class="text-muted">Aucun projet trouv√©</h4>
          <p>Essayez avec d'autres mots-cl√©s</p>
        </div>

      {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
          <i class="bi bi-inbox display-1 text-muted mb-3"></i>
          <h3 class="text-muted">Vous n'avez pas encore de projets</h3>
          <p class="mb-4">Cr√©ez votre premier projet pour commencer √† organiser votre travail</p>
          <a href="{{ path('front_instructors') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> Cr√©er mon premier projet
          </a>
        </div>
      {% endif %}

    </div>

  </section>
  <!-- End Projects Listing Section -->

</main>

<script>
// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-projects');
  const projectCards = document.querySelectorAll('.project-card');
  const noResults = document.getElementById('no-results');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      let visibleCount = 0;
      
      projectCards.forEach(card => {
        const title = card.querySelector('h4').textContent.toLowerCase();
        const description = card.querySelector('p').textContent.toLowerCase();
        const technologies = card.querySelector('.badge.bg-light')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm) || description.includes(searchTerm) || technologies.includes(searchTerm)) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Show/hide no results message
      if (noResults) {
        if (visibleCount === 0 && searchTerm.length > 0) {
          noResults.classList.remove('d-none');
        } else {
          noResults.classList.add('d-none');
        }
      }
    });
  }
  
  // Expand first project's resources on page load
  const firstProject = document.querySelector('.project-card');
  if (firstProject) {
    const firstResourcesBtn = firstProject.querySelector('.view-resources');
    if (firstResourcesBtn) {
      setTimeout(() => {
        firstResourcesBtn.click();
      }, 500);
    }
  }
});
</script>

{% endblock %}

{# Twig functions (you should create these in a Twig extension or use filters) #}
{% macro getTypeColor(type) %}
  {% if type == 'personnel' %}primary
  {% elseif type == 'professionnel' %}success
  {% elseif type == 'academique' %}warning
  {% else %}secondary
  {% endif %}
{% endmacro %}

{% macro getResourceTypeColor(type) %}
  {% if type == 'VIDEO' %}primary
  {% elseif type == 'IMAGE' %}success
  {% elseif type == 'PDF' %}danger
  {% elseif type == 'DOCUMENT' %}info
  {% else %}secondary
  {% endif %}
{% endmacro %}

{% macro getResourceIcon(type) %}
  {% if type == 'VIDEO' %}play-circle
  {% elseif type == 'IMAGE' %}image
  {% elseif type == 'PDF' %}file-pdf
  {% elseif type == 'DOCUMENT' %}file-earmark-text
  {% else %}link-45deg
  {% endif %}
{% endmacro %}