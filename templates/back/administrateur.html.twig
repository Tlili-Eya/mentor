{% extends 'back/base.html.twig' %}

{% block title %}Instructors Management{% endblock %}

{% block body %}
<!-- Page Title -->
<div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center">
    <h1 class="mb-2 mb-lg-0 text-primary">Instructors Management</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{{ path('back_home') }}">Home</a></li>
        <li class="current">Instructors</li>
      </ol>
    </nav>
  </div>
</div>

<section class="section">
  <div class="container">
    
    <!-- Header actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0 text-secondary">Manage Instructors</h2>
      
      <div class="d-flex gap-2">
        <!-- Export Buttons -->
        <button type="button" class="btn btn-success" id="exportExcelBtn">
          <i class="bi bi-file-earmark-excel me-1"></i> Export to Excel
        </button>
        <button type="button" class="btn btn-warning" id="exportPdfBtn">
          <i class="bi bi-file-earmark-pdf me-1"></i> Export to PDF
        </button>
        
        <!-- Red action button (same as Enroll Now / Admin) -->
        <a href="{{ path('app_utilisateur_new') }}" class="btn btn-danger">
          <i class="bi bi-plus-circle me-1"></i> Add Instructor
        </a>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-3 g-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" 
                 class="form-control border-start-0" 
                 placeholder="Search by name, email, or role..." 
                 id="searchInput">
        </div>
      </div>
      <div class="col-md-4">
        <select class="form-select" id="sortSelect">
          <option value="">Sort by</option>
          <option value="name">Name (A-Z)</option>
          <option value="email">Email (A-Z)</option>
          <option value="role">Role</option>
          <option value="date">Registration Date</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-outline-secondary w-100" id="resetBtn">
          <i class="bi bi-arrow-clockwise"></i> Reset
        </button>
      </div>
    </div>
    
    <!-- Results counter -->
    <div class="mb-2">
      <small class="text-muted">
        Showing <strong id="resultCount">{{ utilisateurs|length }}</strong> of {{ utilisateurs|length }} instructor(s)
      </small>
    </div>
    
    <!-- Table -->
    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="instructorsTable">
            <thead style="background-color: #eef3f7;">
              <tr class="text-secondary">
                <th>#</th>
                <th>Instructor</th>
                <th>Email</th>
                <th>Role</th>
                <th>Registration Date</th>
                <th>Status</th>
                <th class="text-end no-export">Actions</th>
              </tr>
            </thead>
            
            <tbody id="tableBody">
              {% for utilisateur in utilisateurs %}
              <tr class="data-row">
                <td>{{ utilisateur.id }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    {% if utilisateur.pdpUrl %}
                      <img src="{{ asset('uploads/pdp/' ~ utilisateur.pdpUrl) }}" 
                           alt="{{ utilisateur.prenom ~ ' ' ~ utilisateur.nom }}" 
                           class="rounded-circle me-2" 
                           style="width: 40px; height: 40px; object-fit: cover;">
                    {% else %}
                      <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center me-2" 
                           style="width: 40px; height: 40px; font-size: 0.9rem;">
                        {{ utilisateur.prenom|first|upper }}{{ utilisateur.nom|first|upper }}
                      </div>
                    {% endif %}
                    <div>
                      <strong class="text-dark">{{ utilisateur.prenom }} {{ utilisateur.nom }}</strong><br>
                      <small class="text-muted">ID: {{ utilisateur.id }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <a href="mailto:{{ utilisateur.email }}" class="text-primary text-decoration-none">
                    {{ utilisateur.email }}
                  </a>
                </td>
                <td>
                  <span class="badge {% if utilisateur.role == 'administrateur' %}bg-danger{% elseif utilisateur.role == 'enseignant' %}bg-primary{% elseif utilisateur.role == 'etudiant' %}bg-info{% else %}bg-secondary{% endif %}">
                    {{ utilisateur.role|upper }}
                  </span>
                </td>
                <td>
                  {% if utilisateur.dateInscription %}
                    <i class="bi bi-calendar-event me-1"></i>
                    {{ utilisateur.dateInscription|date('Y-m-d') }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-success">ACTIVE</span>
                </td>
                <td class="text-end no-export">
                  <a href="{{ path('app_utilisateur_show', {'id': utilisateur.id}) }}" 
                     class="btn btn-sm btn-outline-info me-1" 
                     title="View"
                     data-bs-toggle="tooltip">
                     <i class="bi bi-eye"></i>
                  </a>
                  <a href="{{ path('app_utilisateur_edit', {'id': utilisateur.id}) }}" 
                     class="btn btn-sm btn-outline-primary me-1" 
                     title="Edit"
                     data-bs-toggle="tooltip">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <button type="button" 
                          class="btn btn-sm btn-outline-danger" 
                          data-bs-toggle="modal" 
                          data-bs-target="#deleteModal{{ utilisateur.id }}" 
                          title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              
              <!-- Delete Modal -->
              <div class="modal fade" id="deleteModal{{ utilisateur.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ utilisateur.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteModalLabel{{ utilisateur.id }}">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Confirm Deletion
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="alert alert-danger border-0">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                      </div>
                      <p class="mb-0">
                        Are you sure you want to delete <strong>{{ utilisateur.prenom }} {{ utilisateur.nom }}</strong>?
                        <br><small class="text-muted">All associated data will be permanently removed.</small>
                      </p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                      </button>
                      <form method="post" action="{{ path('app_utilisateur_delete', {'id': utilisateur.id}) }}" style="display: inline;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ utilisateur.id) }}">
                        <button type="submit" class="btn btn-danger">
                          <i class="bi bi-trash me-1"></i> Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% else %}
              <tr class="no-data-row">
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-2">No instructors found</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Footer info -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <p class="text-muted mb-0">
        Total: <strong>{{ utilisateurs|length }}</strong> instructor(s)
      </p>
    </div>
    
  </div>
</section>

<!-- Include libraries for export functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- Search, Sort and Filter Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const resetBtn = document.getElementById('resetBtn');
  const tableBody = document.getElementById('tableBody');
  const resultCount = document.getElementById('resultCount');
  const exportExcelBtn = document.getElementById('exportExcelBtn');
  const exportPdfBtn = document.getElementById('exportPdfBtn');
  
  // Get all data rows (excluding modals and no-data-row)
  const allRows = Array.from(document.querySelectorAll('.data-row'));
  const totalRows = allRows.length;
  
  // Search functionality - INSTANT SEARCH
  if (searchInput) {
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase().trim();
      filterAndDisplay(searchTerm);
    });
  }
  
  // Sort functionality
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      const sortBy = this.value;
      sortRows(sortBy);
    });
  }
  
  // Reset button
  if (resetBtn) {
    resetBtn.addEventListener('click', function() {
      searchInput.value = '';
      sortSelect.value = '';
      filterAndDisplay('');
      
      // Reset to original order
      allRows.forEach(row => tableBody.appendChild(row));
      
      // Show success message
      showNotification('Filters reset successfully', 'success');
    });
  }
  
  // Export to Excel functionality
  if (exportExcelBtn) {
    exportExcelBtn.addEventListener('click', function() {
      exportToExcel();
    });
  }
  
  // Export to PDF functionality
  if (exportPdfBtn) {
    exportPdfBtn.addEventListener('click', function() {
      exportToPDF();
    });
  }
  
  // Filter and display rows
  function filterAndDisplay(searchTerm) {
    let visibleCount = 0;
    
    allRows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const isVisible = text.includes(searchTerm);
      
      row.style.display = isVisible ? '' : 'none';
      if (isVisible) visibleCount++;
    });
    
    // Update result count
    if (resultCount) {
      resultCount.textContent = visibleCount;
    }
    
    // Show/hide "no results" message
    showNoResultsMessage(visibleCount);
  }
  
  // Sort rows
  function sortRows(sortBy) {
    if (!sortBy) return;
    
    const sortedRows = [...allRows].sort((a, b) => {
      let aValue, bValue;
      
      switch(sortBy) {
        case 'name':
          // Column index 1 (Instructor name)
          aValue = a.cells[1].textContent.trim().toLowerCase();
          bValue = b.cells[1].textContent.trim().toLowerCase();
          break;
        case 'email':
          // Column index 2 (Email)
          aValue = a.cells[2].textContent.trim().toLowerCase();
          bValue = b.cells[2].textContent.trim().toLowerCase();
          break;
        case 'role':
          // Column index 3 (Role)
          aValue = a.cells[3].textContent.trim().toLowerCase();
          bValue = b.cells[3].textContent.trim().toLowerCase();
          break;
        case 'date':
          // Column index 4 (Registration Date)
          const dateA = a.cells[4].textContent.trim();
          const dateB = b.cells[4].textContent.trim();
          aValue = dateA === 'N/A' ? '0000-00-00' : dateA;
          bValue = dateB === 'N/A' ? '0000-00-00' : dateB;
          // Sort descending (most recent first)
          return bValue.localeCompare(aValue);
        default:
          return 0;
      }
      
      return aValue.localeCompare(bValue);
    });
    
    // Re-append rows in sorted order
    sortedRows.forEach(row => tableBody.appendChild(row));
    
    showNotification(`Sorted by ${sortBy}`, 'info');
  }
  
  // Export to Excel function
  function exportToExcel() {
    try {
      // Get visible rows only
      const visibleRows = allRows.filter(row => row.style.display !== 'none');
      
      if (visibleRows.length === 0) {
        showNotification('No data to export', 'warning');
        return;
      }
      
      // Prepare data for Excel
      const data = [];
      
      // Add headers
      data.push(['ID', 'Instructor Name', 'Email', 'Role', 'Registration Date', 'Status']);
      
      // Add data rows
      visibleRows.forEach(row => {
        const cells = row.cells;
        const id = cells[0].textContent.trim();
        const name = cells[1].textContent.trim().replace(/ID:\s*\d+/g, '').trim();
        const email = cells[2].textContent.trim();
        const role = cells[3].textContent.trim();
        const date = cells[4].textContent.trim().replace(/\s+/g, ' ');
        const status = cells[5].textContent.trim();
        
        data.push([id, name, email, role, date, status]);
      });
      
      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 8 },  // ID
        { wch: 25 }, // Name
        { wch: 30 }, // Email
        { wch: 15 }, // Role
        { wch: 20 }, // Date
        { wch: 12 }  // Status
      ];
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Instructors');
      
      // Generate filename with timestamp
      const timestamp = new Date().toISOString().slice(0, 10);
      const filename = `instructors_${timestamp}.xlsx`;
      
      // Save file
      XLSX.writeFile(wb, filename);
      
      showNotification('Excel file exported successfully!', 'success');
    } catch (error) {
      console.error('Export error:', error);
      showNotification('Error exporting to Excel', 'danger');
    }
  }
  
  // Export to PDF function
  function exportToPDF() {
    try {
      // Get visible rows only
      const visibleRows = allRows.filter(row => row.style.display !== 'none');
      
      if (visibleRows.length === 0) {
        showNotification('No data to export', 'warning');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation
      
      // Add title
      doc.setFontSize(18);
      doc.setTextColor(40, 40, 40);
      doc.text('Instructors Management Report', 14, 15);
      
      // Add date
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
      
      // Prepare data for PDF table
      const headers = [['ID', 'Instructor Name', 'Email', 'Role', 'Registration Date', 'Status']];
      const data = [];
      
      visibleRows.forEach(row => {
        const cells = row.cells;
        const id = cells[0].textContent.trim();
        const name = cells[1].textContent.trim().replace(/ID:\s*\d+/g, '').trim();
        const email = cells[2].textContent.trim();
        const role = cells[3].textContent.trim();
        const date = cells[4].textContent.trim().replace(/\s+/g, ' ');
        const status = cells[5].textContent.trim();
        
        data.push([id, name, email, role, date, status]);
      });
      
      // Add table
      doc.autoTable({
        head: headers,
        body: data,
        startY: 28,
        theme: 'striped',
        headStyles: {
          fillColor: [41, 128, 185],
          textColor: 255,
          fontSize: 10,
          fontStyle: 'bold',
          halign: 'left'
        },
        bodyStyles: {
          fontSize: 9,
          textColor: 50
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        columnStyles: {
          0: { cellWidth: 15, halign: 'center' },  // ID
          1: { cellWidth: 50 },  // Name
          2: { cellWidth: 65 },  // Email
          3: { cellWidth: 30, halign: 'center' },  // Role
          4: { cellWidth: 40, halign: 'center' },  // Date
          5: { cellWidth: 25, halign: 'center' }   // Status
        },
        margin: { top: 28, left: 14, right: 14 },
        didDrawPage: function (data) {
          // Add footer with page number
          const pageCount = doc.internal.getNumberOfPages();
          doc.setFontSize(8);
          doc.setTextColor(150);
          doc.text(
            `Page ${data.pageNumber} of ${pageCount}`,
            doc.internal.pageSize.width / 2,
            doc.internal.pageSize.height - 10,
            { align: 'center' }
          );
        }
      });
      
      // Add summary at the bottom
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      doc.setTextColor(60, 60, 60);
      doc.text(`Total Instructors: ${visibleRows.length}`, 14, finalY);
      
      // Generate filename with timestamp
      const timestamp = new Date().toISOString().slice(0, 10);
      const filename = `instructors_${timestamp}.pdf`;
      
      // Save PDF
      doc.save(filename);
      
      showNotification('PDF file exported successfully!', 'success');
    } catch (error) {
      console.error('Export error:', error);
      showNotification('Error exporting to PDF', 'danger');
    }
  }
  
  // Show/hide "no results" message
  function showNoResultsMessage(count) {
    let noResultsRow = document.querySelector('.no-results-row');
    
    if (count === 0 && totalRows > 0) {
      if (!noResultsRow) {
        noResultsRow = document.createElement('tr');
        noResultsRow.className = 'no-results-row';
        noResultsRow.innerHTML = `
          <td colspan="7" class="text-center text-muted py-5">
            <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
            <p class="mt-3 mb-0 fw-semibold">No results found</p>
            <small class="text-muted">Try adjusting your search terms</small>
          </td>
        `;
        tableBody.appendChild(noResultsRow);
      }
      noResultsRow.style.display = '';
    } else {
      if (noResultsRow) {
        noResultsRow.style.display = 'none';
      }
    }
  }
  
  // Show notification (toast-like)
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>

<style>
/* Custom styles for search */
.input-group-text {
  background-color: white !important;
  border-right: 0 !important;
}

.form-control.border-start-0:focus {
  border-left: 0 !important;
  box-shadow: none;
}

/* Smooth transitions for table rows */
.data-row {
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.data-row:hover {
  background-color: #f8f9fa;
  transform: scale(1.01);
}

/* Badge animations */
.badge {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Export button styling */
#exportExcelBtn, #exportPdfBtn {
  transition: all 0.3s ease;
}

#exportExcelBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

#exportPdfBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
</style>

{% endblock %}
