{% extends 'front/base.html.twig' %}

{% block title %}Gestion des Projets - MentorAI
{% endblock %}

{% block stylesheets %}
	<style>:root
	{
		--primary-color: #102c59;
		--secondary-color: #9dbbce;
		--accent-color: #d52e28;
		--bg-light: #f4f7f9;
	}

	.page-title-banner {
		background: linear-gradient(135deg, var(--primary-color) 0%, #1a458a 100%);
		padding: 60px 0;
		color: white;
		border-radius: 0 0 30px 30px;
		margin-bottom: 40px;
	}

	.sidebar-card {
		background: #fff;
		border-radius: 20px;
		box-shadow: 0 10px 30px rgba(16, 44, 89, 0.08);
		border: 1px solid rgba(157, 187, 206, 0.2);
		overflow: hidden;
		margin-bottom: 30px;
	}

	.sidebar-header {
		background: #f8faff;
		padding: 20px 25px;
		border-bottom: 1px solid #e1e8ef;
		font-weight: 800;
		color: var(--primary-color);
	}

	.list-group-item-custom {
		padding: 15px 25px;
		border: none;
		border-left: 4px solid transparent;
		transition: all 0.3s;
		color: #5a6b81;
	}

	.list-group-item-custom:hover {
		background-color: #f8faff;
		color: var(--primary-color);
	}

	.list-group-item-custom.active {
		background-color: rgba(157, 187, 206, 0.1);
		color: var(--primary-color);
		font-weight: 700;
		border-left-color: var(--accent-color);
	}

	.form-card {
		background: #fff;
		border-radius: 20px;
		box-shadow: 0 10px 30px rgba(16, 44, 89, 0.08);
		border: 1px solid rgba(157, 187, 206, 0.2);
		overflow: hidden;
	}

	.form-card-header {
		background: #f8faff;
		padding: 25px 40px;
		border-bottom: 2.5px solid var(--accent-color);
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.form-card-header h4 {
		margin-bottom: 0;
		font-weight: 800;
		color: var(--primary-color);
		display: flex;
		align-items: center;
		gap: 15px;
	}

	.form-card-body {
		padding: 40px;
	}

	.form-label {
		font-weight: 700;
		color: var(--primary-color);
	}

	.form-control,
	.form-select {
		border-radius: 12px;
		padding: 12px 15px;
		border: 1.5px solid #e1e8ef;
		transition: all 0.3s;
	}

	.form-control:focus,
	.form-select:focus {
		border-color: var(--secondary-color);
		box-shadow: 0 0 0 4px rgba(157, 187, 206, 0.15);
	}

	.btn-submit {
		background: var(--primary-color);
		color: white;
		border: none;
		padding: 12px 30px;
		font-weight: 700;
		border-radius: 12px;
		transition: all 0.3s;
	}

	.btn-submit:hover {
		background: #1a458a;
		transform: translateY(-2px);
		box-shadow: 0 5px 15px rgba(16, 44, 89, 0.2);
		color: white;
	}

	.btn-new-project {
		background: var(--accent-color);
		color: white;
		border: none;
		padding: 15px;
		font-weight: 800;
		border-radius: 15px;
		transition: all 0.3s;
		width: 100%;
		margin-bottom: 20px;
		display: block;
		text-align: center;
		text-decoration: none;
	}

	.btn-new-project:hover {
		background: #b92b25;
		transform: translateY(-2px);
		box-shadow: 0 5px 15px rgba(213, 46, 40, 0.3);
		color: white;
	}

	.table-custom {
		margin-top: 20px;
	}

	.table-custom thead th {
		background: #f8faff;
		border-bottom: 2px solid var(--secondary-color);
		color: var(--primary-color);
		font-weight: 800;
		padding: 15px;
	}

	.table-custom tbody td {
		padding: 15px;
		vertical-align: middle;
	}

	.resource-section {
		background: #fcfdfe;
		border-radius: 15px;
		border: 1px dashed var(--secondary-color);
		padding: 25px;
		margin-top: 30px;
	}

	.badge-resource {
		background: var(--primary-color);
		color: white;
		padding: 5px 12px;
		border-radius: 50px;
		font-size: 0.75rem;
		font-weight: 600;
	}
	/* Tab Styles */
	.nav-tabs-custom {
		border: none;
		margin-bottom: 0;
		display: flex;
		gap: 10px;
		padding: 0 40px;
		background: #f8faff;
	}

	.nav-tabs-custom .nav-link {
		border: none;
		background: transparent;
		color: #5a6b81;
		font-weight: 700;
		padding: 15px 25px;
		border-radius: 15px 15px 0 0;
		transition: all 0.3s;
		position: relative;
		margin-bottom: -2px;
	}

	.nav-tabs-custom .nav-link:hover {
		color: var(--primary-color);
		background: rgba(157, 187, 206, 0.1);
	}

	.nav-tabs-custom .nav-link.active {
		color: var(--primary-color);
		background: #fff;
		border-bottom: 3px solid var(--accent-color);
	}

	.nav-tabs-custom .nav-link i {
		margin-right: 8px;
	}

	.tab-content-custom {
		background: #fff;
		border-radius: 0 0 20px 20px;
	}

	.locked-feature-overlay {
		text-align: center;
		padding: 60px 20px;
		background: rgba(248, 250, 255, 0.5);
		border-radius: 15px;
		border: 2px dashed #e1e8ef;
	}
	/* Chatbot Widget Styles */
	.chatbot-widget {
		position: fixed;
		bottom: 30px;
		right: 30px;
		z-index: 1000;
	}

	.chatbot-toggle {
		width: 60px;
		height: 60px;
		background: var(--primary-color);
		color: white;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 24px;
		cursor: pointer;
		box-shadow: 0 5px 15px rgba(16, 44, 89, 0.3);
		transition: all 0.3s;
	}

	.chatbot-toggle:hover {
		transform: scale(1.1);
	}

	.chatbot-window {
		position: absolute;
		bottom: 80px;
		right: 0;
		width: 350px;
		height: 500px;
		background: white;
		border-radius: 20px;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
		display: flex;
		flex-direction: column;
		overflow: hidden;
		opacity: 0;
		pointer-events: none;
		transform: translateY(20px);
		transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
	}

	.chatbot-window.open {
		opacity: 1;
		pointer-events: all;
		transform: translateY(0);
	}

	.chatbot-header {
		background: var(--primary-color);
		color: white;
		padding: 15px 20px;
		font-weight: bold;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.chatbot-messages {
		flex-grow: 1;
		padding: 20px;
		overflow-y: auto;
		display: flex;
		flex-direction: column;
		gap: 10px;
		background: var(--bg-light);
	}

	.chat-message {
		max-width: 85%;
		padding: 10px 15px;
		border-radius: 15px;
		font-size: 0.9rem;
		line-height: 1.4;
	}

	.chat-message.bot {
		background: white;
		color: var(--primary-color);
		align-self: flex-start;
		border-bottom-left-radius: 5px;
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
	}

	.chat-message.user {
		background: var(--secondary-color);
		color: var(--primary-color);
		font-weight: 500;
		align-self: flex-end;
		border-bottom-right-radius: 5px;
	}

	.chatbot-input {
		padding: 15px;
		background: white;
		border-top: 1px solid #eee;
		display: flex;
		gap: 10px;
	}

	.chatbot-input input {
		flex-grow: 1;
		border: 1px solid #ddd;
		border-radius: 20px;
		padding: 8px 15px;
		outline: none;
	}

	.chatbot-input input:focus {
		border-color: var(--secondary-color);
	}

	.chatbot-input button {
		background: var(--primary-color);
		color: white;
		border: none;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: background 0.3s;
	}

	.chatbot-input button:hover {
		background: var(--accent-color);
	}
</style>{% endblock %}{% block body %}
<div class="page-title-banner">
	<div class="container text-center" data-aos="fade-up">
		<h1 class="display-5 fw-bold mb-3">Gestion des Projets</h1>
		<p class="lead opacity-75">Gérez vos réalisations académiques et professionnelles ainsi que leurs ressources.</p>
	</div>
</div>

<div class="container mb-5">
	<div
		class="row g-4">
		<!-- Sidebar -->
		<div class="col-lg-3" data-aos="fade-right">
			<a href="{{ path('front_projets', {'id': 0}) }}" class="btn-new-project">
				<i class="bi bi-plus-lg me-2"></i>
				Nouveau Projet
			</a>

			<div class="sidebar-card">
				<div class="sidebar-header">Mes Projets</div>
				<div class="list-group list-group-flush">
					{% for project in projects %}
						<a href="{{ path('front_projets', {'id': project.id}) }}#project-form-section" class="list-group-item list-group-item-action list-group-item-custom {{ activeProject and activeProject.id == project.id ? 'active' : '' }}">
							<div class="fw-bold text-truncate">{{ project.titre }}</div>
							<small class="opacity-75">{{ project.type }}</small>
						</a>
					{% endfor %}
					{% if projects is empty %}
						<div class="p-4 text-center text-muted italic">
							<small>Aucun projet trouvé</small>
						</div>
					{% endif %}
				</div>
			</div>
		</div>

		<!-- Main Content -->
		<div class="col-lg-9" data-aos="fade-left">
			{% for message in app.flashes('success') %}
				<div class="alert alert-success alert-dismissible fade show rounded-4 border-0 shadow-sm mb-4 p-3" role="alert">
					<i class="bi bi-check-circle-fill me-2"></i>
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}

			<!-- Tabs Navigation -->
			<div class="form-card" id="project-form-section">
				<div class="form-card-header">
					<h4>
						<i class="bi bi-folder2-open"></i>
						{{ activeProject and activeProject.id ? 'Modifier le projet' : 'Créer un projet' }}
					</h4>
					{% if activeProject and activeProject.id %}
						<a href="{{ path('front_delete_project', {'id': activeProject.id}) }}" class="btn btn-sm btn-outline-danger px-3 rounded-pill fw-bold" onclick="return confirm('Supprimer ce projet définitivement ?')">
							<i class="bi bi-trash3 me-1"></i>
							Supprimer
						</a>
					{% endif %}
				</div>

				<ul class="nav nav-tabs nav-tabs-custom" id="projectTabs" role="tablist">
					<li class="nav-item shadow-none" role="presentation">
						<button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
							<i class="bi bi-info-circle"></i>Informations
						</button>
					</li>
					<li class="nav-item shadow-none" role="presentation">
						<button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab" aria-controls="resources" aria-selected="false">
							<i class="bi bi-link-45deg"></i>Ressources
						</button>
					</li>
				</ul>

				<div
					class="tab-content tab-content-custom" id="projectTabsContent">
					<!-- Tab: Informations -->
					<div class="tab-pane fade show active p-4" id="info" role="tabpanel" aria-labelledby="info-tab">
						{{ form_start(projectForm, {'attr': {'novalidate': 'novalidate'}}) }}
						<div class="row g-4">
							<div class="col-md-8">
								{{ form_label(projectForm.titre, null, {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.titre) }}
								<div class="text-danger small">{{ form_errors(projectForm.titre) }}</div>
							</div>
							<div class="col-md-4">
								{{ form_label(projectForm.type, null, {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.type) }}
								<div class="text-danger small">{{ form_errors(projectForm.type) }}</div>
							</div>
							<div class="col-12">
								{{ form_label(projectForm.description, null, {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.description, {'attr': {'rows': 4}}) }}
								<div class="text-danger small">{{ form_errors(projectForm.description) }}</div>
							</div>
							<div class="col-12">
								{{ form_label(projectForm.technologies, null, {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.technologies, {'attr': {'placeholder': 'PHP, Symfony, Bootstrap...'}}) }}
								<div class="text-danger small">{{ form_errors(projectForm.technologies) }}</div>
							</div>
							<div class="col-md-6">
								{{ form_label(projectForm.dateDebut, 'Date de début', {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.dateDebut) }}
								<div class="text-danger small">{{ form_errors(projectForm.dateDebut) }}</div>
							</div>
							<div class="col-md-6">
								{{ form_label(projectForm.dateFin, 'Date de fin', {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.dateFin) }}
								<div class="text-danger small">{{ form_errors(projectForm.dateFin) }}</div>
							</div>
							<div class="col-12">
								{{ form_label(projectForm.parcours, 'Associer à un parcours', {'label_attr': {'class': 'form-label'}}) }}
								{{ form_widget(projectForm.parcours) }}
								<div class="text-danger small">{{ form_errors(projectForm.parcours) }}</div>
							</div>
						</div>
						<div class="mt-5 text-end">
							<button type="submit" class="btn btn-submit">
								<i class="bi bi-save2 me-2"></i>
								{{ activeProject and activeProject.id ? 'Mettre à jour le projet' : 'Enregistrer le nouveau projet' }}
							</button>
						</div>
						{{ form_end(projectForm) }}
					</div>

					<!-- Tab: Ressources -->
					<div class="tab-pane fade p-4" id="resources" role="tabpanel" aria-labelledby="resources-tab">
						{% if activeProject and activeProject.id %}
							{% if activeProject.ressources is empty %}
								<div class="text-center py-4">
									<i class="bi bi-cloud-upload d-block display-4 text-light mb-3"></i>
									<p class="text-muted">Aucune ressource associée à ce projet.</p>
								</div>
							{% else %}
								<div class="table-responsive">
									<table class="table table-custom">
										<thead>
											<tr>
												<th>Type</th>
												<th>Nom du lien</th>
												<th class="text-end">Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for resource in activeProject.ressources %}
												<tr>
													<td>
														<span class="badge-resource">{{ resource.typeRessource.value }}</span>
													</td>
													<td>
														<a href="{{ resource.urlRessource }}" target="_blank" class="fw-bold text-decoration-none" style="color: var(--primary-color);">
															{{ resource.nom }}
															<i class="bi bi-box-arrow-up-right ms-1 small"></i>
														</a>
													</td>
													<td class="text-end">
														<a href="{{ path('front_projets', {'id': activeProject.id, 'resource_id': resource.id}) }}#project-form-section" class="btn btn-sm btn-outline-primary me-2 rounded-pill">
															<i class="bi bi-pencil"></i>
														</a>
														<a href="{{ path('front_delete_ressource', {'id': resource.id}) }}" class="btn btn-sm btn-outline-danger rounded-pill" onclick="return confirm('Supprimer cette ressource ?')">
															<i class="bi bi-trash"></i>
														</a>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							{% endif %}

							<div class="resource-section mt-4" id="resource-form-section">
								<h6 class="fw-bold mb-4">
									<i class="bi {{ resourceForm.vars.value.id ? 'bi-pencil-fill' : 'bi-plus-circle-fill' }} me-2"></i>
									{{ resourceForm.vars.value.id ? 'Modifier la ressource' : 'Ajouter une nouvelle ressource' }}
								</h6>
								{{ form_start(resourceForm, {'attr': {'enctype': 'multipart/form-data'}}) }}
								<div class="row g-3">
									<div class="col-md-6">
										{{ form_widget(resourceForm.nom, {'attr': {'placeholder': 'Nom de la ressource'}}) }}
										<div class="text-danger small">{{ form_errors(resourceForm.nom) }}</div>
									</div>
									<div class="col-md-6">
										{{ form_widget(resourceForm.typeRessource) }}
										<div class="text-danger small">{{ form_errors(resourceForm.typeRessource) }}</div>
									</div>
									<div class="col-12">
										{{ form_label(resourceForm.urlRessource, 'Lien URL (optionnel)') }}
										{{ form_widget(resourceForm.urlRessource, {'attr': {'placeholder': 'URL (ex: https://github.com/...)'}}) }}
										<div class="text-danger small">{{ form_errors(resourceForm.urlRessource) }}</div>
									</div>
									<div class="col-12">
										{{ form_label(resourceForm.fichier, 'Ou importer un fichier (Tous types : SQL, ZIP, PDF...)') }}
										{{ form_widget(resourceForm.fichier) }}
										<div class="text-danger small">{{ form_errors(resourceForm.fichier) }}</div>
									</div>
									<div class="col-12">
										{{ form_widget(resourceForm.description, {'attr': {'placeholder': 'Courte description', 'rows': 2}}) }}
										<div class="text-danger small">{{ form_errors(resourceForm.description) }}</div>
									</div>
								</div>
								<div class="mt-3 d-flex justify-content-end gap-2">
									{% if resourceForm.vars.value.id %}
										<a href="{{ path('front_projets', {'id': activeProject.id}) }}" class="btn btn-light rounded-pill px-4">Annuler</a>
									{% endif %}
									<button type="submit" class="btn btn-submit rounded-pill">
										{{ resourceForm.vars.value.id ? 'Modifier' : 'Ajouter' }}
									</button>
								</div>
								{{ form_end(resourceForm) }}
							</div>
						{% else %}
							<!-- Message for new projects -->
							<div class="locked-feature-overlay">
								<i class="bi bi-lock-fill display-4 text-muted mb-3 d-block"></i>
								<h5 class="fw-bold text-dark">Ressources indisponibles</h5>
								<p class="text-muted">Veuillez d'abord enregistrer le projet dans l'onglet
									<strong>"Informations"</strong>
									pour pouvoir y ajouter des ressources.</p>
								<button class="btn btn-primary rounded-pill mt-3 px-4" onclick="document.getElementById('info-tab').click()">
									Retour aux informations
								</button>
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- Chatbot UI -->
<div class="chatbot-widget">
	<div class="chatbot-window" id="chatbotWindow">
		<div class="chatbot-header">
			<span>
				<i class="bi bi-robot me-2"></i>Assistant MentorAI</span>
			<i class="bi bi-x-lg" style="cursor:pointer" onclick="toggleChat()"></i>
		</div>
		<div class="chatbot-messages" id="chatMessages">
			<div class="chat-message bot">Salut ! Je suis ton assistant IA. Que cherches-tu à créer comme projet aujourd'hui ? Je peux te proposer des idées, des ressources et t'aider à remplir le formulaire.</div>
		</div>
		<div class="chatbot-input">
			<input type="text" id="chatInput" placeholder="Écris un message..." onkeypress="handleEnter(event)">
			<button onclick="sendMessage()">
				<i class="bi bi-send-fill"></i>
			</button>
		</div>
	</div>
	<div class="chatbot-toggle" onclick="toggleChat()">
		<i class="bi bi-chat-dots-fill"></i>
	</div>
</div>

<script>
	function confirmDelete(url, projectName) {
const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
document.getElementById('deleteProjectName').textContent = projectName;
document.getElementById('confirmDeleteBtn').href = url;
modal.show();
}

// Auto-activate tab based on URL hash or parameters
document.addEventListener('DOMContentLoaded', function () {
const urlParams = new URLSearchParams(window.location.search);
const hasResourceId = urlParams.has('resource_id');
const hasHash = window.location.hash === '#resource-form-section' || window.location.hash === '#resources';

if (hasResourceId || hasHash) {
const resourcesTab = document.getElementById('resources-tab');
if (resourcesTab) {
bootstrap.Tab.getInstance(resourcesTab) ?. show() || new bootstrap.Tab(resourcesTab).show();
}
}
});

// --- Chatbot Logic ---
let chatHistory = [{
role: "system",
content: `Tu es un assistant IA sur le site MentorAI. Ton unique rôle est d'aider l'utilisateur à créer un projet académique ou professionnel, en lui proposant des idées de projets et des ressources. 
RÈGLES STRICTES :
1. TU NE DOIS RÉPONDRE À AUCUNE QUESTION HORS DU SUJET des projets informatiques, académiques ou professionnels. Si on te pose une question hors sujet (ex: météo, cuisine, blagues...), réponds poliment et fermement que tu es là uniquement pour parler de la création de projets sur MentorAI et recadre la discussion.
2. Lorsque tu proposes une idée de projet, attends TOUJOURS que l'utilisateur dise qu'il l'accepte ou la CONFIRME avant d'envoyer un code JSON.
3. SI ET SEULEMENT SI l'utilisateur dit explicitement qu'il valide, accepte ou "confirme" l'idée de projet (ex: "je confirme", "oui on part là dessus", "j'accepte cette idée"), ALORS tu DOIS inclure à la fin de ta réponse un bloc JSON EXACTEMENT sous ce format :
\`\`\`json
{
	"fill_form": true,
	"titre": "Le titre du projet",
	"type": "Type du projet (Web, Mobile, Data, etc...)",
	"description": "Une description claire et détaillée du projet et de ses objectifs.",
	"technologies": "Les technologies (EX: PHP, Symfony, React)"
}
\`\`\`
NE METS CE BLOC JSON SOUS AUCUN PRÉTEXTE SI L'UTILISATEUR N'A PAS DIT QU'IL CONFIRME L'IDÉE. N'invente pas un format différent, respecte strictement la structure JSON. Sois convivial, mais respecte impérativement ces règles.`
}];

function toggleChat() {
document.getElementById('chatbotWindow').classList.toggle('open');
}

function handleEnter(e) {
if (e.key === 'Enter') {
sendMessage();
}
}

async function sendMessage() {
const inputField = document.getElementById('chatInput');
const message = inputField.value.trim();
if (! message) 
return;


appendMessage('user', message);
inputField.value = '';

chatHistory.push({role: "user", content: message});

appendMessage('bot', '<i class="bi bi-three-dots"></i>');
const msgsContainer = document.getElementById('chatMessages');
const loadingMsg = msgsContainer.lastChild;

try {
const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': 'Bearer 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'
},
body: JSON.stringify(
{model: "llama-3.1-8b-instant", messages: chatHistory}
)
});

const data = await response.json();
msgsContainer.removeChild(loadingMsg);

if (data.choices && data.choices.length > 0) {
const aiMessage = data.choices[0].message.content;
chatHistory.push({role: "assistant", content: aiMessage});

// Parse json block
const jsonRegex = /\`\`\`json\n([\s\S]*?)\n\`\`\`/i;
const match = aiMessage.match(jsonRegex);

let displayMessage = aiMessage;
if (match) {
try {
const projectData = JSON.parse(match[1]);
if (projectData.fill_form) {
fillForm(projectData);
displayMessage = displayMessage.replace(match[0], '<br><span class="badge bg-success py-2 px-3 fw-bold text-wrap"><i class="bi bi-check-circle me-1"></i> Formulaire pré-rempli avec les informations du projet !</span><br>');
}
} catch (e) {
console.error("Erreur parsing JSON:", e);
}
}

// Basic markdown formatting
displayMessage = displayMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
displayMessage = displayMessage.replace(/\n/g, '<br>');

appendMessage('bot', displayMessage);
} else {
const errorMsg = data.error && data.error.message ? data.error.message : "Je n'ai pas pu générer de réponse.";
appendMessage('bot', "Erreur API : " + errorMsg);
}
} catch (error) {
if (msgsContainer.contains(loadingMsg)) 
msgsContainer.removeChild(loadingMsg);

appendMessage('bot', "Désolé, une erreur de connexion à l'IA est survenue. " + error.message);
console.error(error);
}
}

function appendMessage(sender, text) {
const msgsContainer = document.getElementById('chatMessages');
const msgDiv = document.createElement('div');
msgDiv.className = `chat-message ${sender}`;
msgDiv.innerHTML = text;
msgsContainer.appendChild(msgDiv);
msgsContainer.scrollTop = msgsContainer.scrollHeight;
}

function fillForm(data) {
const titreInput = document.querySelector('[name$="[titre]"]');
const typeInput = document.querySelector('[name$="[type]"]');
const descInput = document.querySelector('[name$="[description]"]');
const techInput = document.querySelector('[name$="[technologies]"]');

if (titreInput) 
titreInput.value = data.titre || '';

if (typeInput) {
if (typeInput.options) { // Try to find a matching option
let found = false;
Array.from(typeInput.options).forEach(opt => {
if (opt.text.toLowerCase().includes(data.type.toLowerCase()) || (data.type.toLowerCase().includes(opt.value.toLowerCase()) && opt.value !== "")) {
typeInput.value = opt.value;
found = true;
}
});
if (! found && typeInput.options.length > 0) { // Fallback to first non-empty option if no match
typeInput.value = typeInput.options[1] ? typeInput.options[1].value : typeInput.options[0].value;
}
} else {
typeInput.value = data.type || '';
}
}
if (descInput) 
descInput.value = data.description || '';

if (techInput) 
techInput.value = data.technologies || '';


const infoTab = document.getElementById('info-tab');
if (infoTab) 
infoTab.click();


const formSection = document.getElementById('project-form-section');
if (formSection) {
formSection.scrollIntoView({behavior: 'smooth'});

// Highlight the form to show it was updated
formSection.style.transition = 'box-shadow 0.5s ease-in-out';
formSection.style.boxShadow = '0 0 25px var(--accent-color)';
setTimeout(() => {
formSection.style.boxShadow = '0 10px 30px rgba(16, 44, 89, 0.08)';
}, 3000);
}
}
</script>{% endblock %}
