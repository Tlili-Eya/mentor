{% extends 'front/base.html.twig' %}

{% block title %}MentorAI - Offres d'Emploi IA
{% endblock %}

{% block stylesheets %}
	<style>:root
	{
		--color-deep-navy: #102c59;
		--color-steel-blue: #9dbbce;
		--color-accent-red: #d52e28;
		--primary-gradient: linear-gradient(135deg, var(--color-deep-navy) 0%, #1a3c78 100%);
		--accent-gradient: linear-gradient(135deg, var(--color-accent-red) 0%, #a0231e 100%);
		--glass-bg: rgba(157, 187, 206, 0.08);
		--glass-border: rgba(157, 187, 206, 0.15);
		--text-muted: #9dbbce;
	}

	.ai-hero-section {
		padding: 100px 0 60px;
		background: radial-gradient(circle at top right, rgba(213, 46, 40, 0.1), transparent), radial-gradient(circle at bottom left, rgba(16, 44, 89, 0.8), var(--color-deep-navy));
		min-height: 400px;
		color: #fff;
		text-align: center;
	}

	.ai-badge {
		background: var(--accent-gradient);
		padding: 6px 18px;
		border-radius: 50px;
		font-size: 0.85rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 1.5px;
		display: inline-block;
		margin-bottom: 25px;
		box-shadow: 0 4px 15px rgba(213, 46, 40, 0.4);
	}

	.glass-card {
		background: var(--glass-bg);
		backdrop-filter: blur(16px);
		-webkit-backdrop-filter: blur(16px);
		border: 1px solid var(--glass-border);
		border-radius: 24px;
		padding: 35px;
		transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		position: relative;
		overflow: hidden;
	}

	.glass-card:hover {
		transform: translateY(-12px);
		background: rgba(157, 187, 206, 0.12);
		border-color: rgba(157, 187, 206, 0.3);
		box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
	}

	.match-score {
		width: 65px;
		height: 65px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 800;
		font-size: 1.2rem;
		background: var(--accent-gradient);
		color: white;
		margin-bottom: 25px;
		box-shadow: 0 0 25px rgba(213, 46, 40, 0.4);
	}

	.job-title {
		font-size: 1.5rem;
		font-weight: 700;
		margin-bottom: 12px;
		color: #fff;
	}

	.job-details {
		color: var(--text-muted);
		font-size: 1rem;
		margin-bottom: 25px;
	}

	.job-details i {
		margin-right: 10px;
		color: var(--color-accent-red);
	}

	.btn-apply {
		background: var(--accent-gradient);
		border: none;
		color: white;
		padding: 14px 30px;
		border-radius: 12px;
		font-weight: 700;
		width: 100%;
		transition: all 0.3s ease;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.btn-apply:hover {
		opacity: 0.95;
		transform: scale(1.02);
		color: white;
		box-shadow: 0 8px 20px rgba(213, 46, 40, 0.3);
	}

	/* Shimmer Loading Effect */
	.skeleton {
		background: linear-gradient(90deg, #102c59 25%, #1a3c78 50%, #102c59 75%);
		background-size: 200% 100%;
		animation: shimmer 1.8s infinite;
		border-radius: 6px;
	}

	@keyframes shimmer {
		0% {
			background-position: 200% 0;
		}
		100% {
			background-position: -200% 0;
		}
	}

	.loading-container {
		display: none;
		gap: 30px;
	}

	#recommendations-container {
		min-height: 500px;
		padding: 60px 0;
		background: #08162d; /* Even deeper navy */
	}

	h2 {
		color: white;
		font-weight: 800;
	}
	p.lead {
		color: var(--color-steel-blue) !important;
	}
	.premium-border {
		border: 2px solid var(--color-accent-red) !important;
		box-shadow: 0 0 30px rgba(213, 46, 40, 0.2) !important;
	}

	#job-map {
		height: 450px;
		width: 100%;
		border-radius: 24px;
		border: 1px solid var(--glass-border);
		margin-bottom: 50px;
		z-index: 1;
	}

	.leaflet-popup-content-wrapper {
		background: var(--color-deep-navy);
		color: white;
		border: 1px solid var(--glass-border);
		backdrop-filter: blur(10px);
	}

	.leaflet-popup-tip {
		background: var(--color-deep-navy);
	}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>{% endblock %}{% block body %}
<section class="ai-hero-section">
	<div class="container" data-aos="fade-up">
		<span class="ai-badge">Intelligence Artificielle</span>
		<h1 class="display-3 fw-bold mb-4">Recommandations de Carrière</h1>
		<p class="lead mb-5 mx-auto" style="max-width: 800px; font-size: 1.25rem;">
			Analyse haute performance de vos projets et de votre parcours académique.
		</p>
		<button id="start-analysis" class="btn btn-lg rounded-pill px-5 shadow-lg btn-apply" style="width: auto; padding: 18px 45px; font-size: 1.1rem;">
			Lancer l'Analyse IA
		</button>
	</div>
</section>

<div id="recommendations-container">
	<div class="container">
		<div id="empty-state" class="text-center py-5" data-aos="fade-in">
			<div class="match-score mx-auto mb-4" style="background: rgba(157, 187, 206, 0.05); color: var(--color-steel-blue); border: 1px solid var(--glass-border);">
				<i class="bi bi-cpu fs-1"></i>
			</div>
			<h3 class="text-white fw-bold">Découvrez vos opportunités</h3>
			<p class="opacity-75" style="color: var(--color-steel-blue)">Cliquez sur le bouton ci-dessus pour activer le moteur de recommandation.</p>
		</div>

		<div id="loading" class="row loading-container">
			{% for i in 1..3 %}
				<div class="col-lg-4 mb-4">
					<div class="glass-card">
						<div class="skeleton mb-4" style="width: 65px; height: 65px; border-radius: 50%;"></div>
						<div class="skeleton mb-3" style="width: 85%; height: 30px;"></div>
						<div class="skeleton mb-4" style="width: 65%; height: 20px;"></div>
						<div class="skeleton mb-3" style="width: 100%; height: 120px;"></div>
						<div class="skeleton" style="width: 100%; height: 50px;"></div>
					</div>
				</div>
			{% endfor %}
		</div>

		<div
			id="results" class="row">
			<!-- Suggestions Section -->
			<div id="suggestions-section" class="col-12 mb-5" style="display: none;">
				<h2 class="h3 fw-bold text-white mb-4">
					<i class="bi bi-rocket-takeoff me-2 text-danger"></i>Parcours "Next-Step" suggérés</h2>
				<div id="suggestions-row" class="row"></div>
			</div>

			<!-- Map Section -->
			<div id="map-section" class="col-12 mb-5" style="display: none;">
				<h2 class="h3 fw-bold text-white mb-4">
					<i class="bi bi-map me-2 text-danger"></i>Géolocalisation des Opportunités</h2>
				<div id="job-map"></div>
			</div>

			<!-- Jobs Section -->
			<div id="jobs-section" class="col-12" style="display: none;">
				<h2 class="h3 fw-bold text-white mb-4">
					<i class="bi bi-briefcase me-2 text-danger"></i>Opportunités de Carrière</h2>
				<div id="jobs-row" class="row"></div>
			</div>
		</div>
	</div>
</div>{% endblock %}{% block javascripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
	let map = null;

document.getElementById('start-analysis').addEventListener('click', function () {
const startBtn = this;
const emptyState = document.getElementById('empty-state');
const loading = document.getElementById('loading');
const results = document.getElementById('results');
const suggestionsSection = document.getElementById('suggestions-section');
const suggestionsRow = document.getElementById('suggestions-row');
const jobsSection = document.getElementById('jobs-section');
const jobsRow = document.getElementById('jobs-row');
const mapSection = document.getElementById('map-section');

function initMap(jobs) {
if (map) {
map.remove();
}

const validJobs = jobs.filter(j => j.latitude && j.longitude);
if (validJobs.length === 0) {
mapSection.style.display = 'none';
return;
}

mapSection.style.display = 'block';
map = L.map('job-map').setView([
46.603354, 1.888334
], 6); // Center of France

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
subdomains: 'abcd',
maxZoom: 20
}).addTo(map);

const markerGroup = L.featureGroup();

validJobs.forEach(job => {
const marker = L.marker([job.latitude, job.longitude]);
marker.bindPopup(`
            <div style="font-family: 'Ubuntu', sans-serif;">
                <h6 style="color: #d52e28; margin-bottom: 5px;">${
job.title
}</h6>
                <p style="margin-bottom: 3px;"><strong>${
job.company
}</strong></p>
                <p style="margin-bottom: 10px; font-size: 0.8rem;">${
job.location
}</p>
                <a href="${
job.url
}" target="_blank" style="color: #9dbbce; text-decoration: none; font-weight: bold; font-size: 0.8rem;">Voir l'offre &rarr;</a>
            </div>
        `);
marker.addTo(markerGroup);
});

markerGroup.addTo(map);
map.fitBounds(markerGroup.getBounds(), {
padding: [50, 50]
});
}

// UI State
startBtn.disabled = true;
startBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Analyse en cours...';
emptyState.style.display = 'none';
loading.style.display = 'flex';
suggestionsSection.style.display = 'none';
jobsSection.style.display = 'none';
mapSection.style.display = 'none';
suggestionsRow.innerHTML = '';
jobsRow.innerHTML = '';

// Fetch Recommendations
fetch('{{ path('api_job_recommendations') }}').then(response => {
if (!response.ok) 
throw new Error('Erreur HTTP: ' + response.status);

return response.json();
}).then(data => {
console.log('Données reçues:', data);
loading.style.display = 'none';
startBtn.disabled = false;
startBtn.innerHTML = 'Relancer l\'Analyse IA';

if (data.error) {
jobsRow.innerHTML = `<div class="col-12 text-center text-danger"><p>${
data.error
}</p></div>`;
jobsSection.style.display = 'block';
return;
}

// 1. Display Suggestions
if (data.suggestions && data.suggestions.length > 0) {
suggestionsSection.style.display = 'block';
data.suggestions.forEach((item, index) => {
const suggCard = `
            <div class="col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="${
index * 100
}">
                <div class="glass-card h-100" style="border-left: 4px solid var(--color-accent-red)">
                    <div class="mb-3">
                        <i class="bi ${
item.icon
} fs-2 text-danger"></i>
                    </div>
                    <h4 class="text-white fw-bold mb-3">${
item.title
}</h4>
                    <p class="opacity-75" style="color: var(--color-steel-blue)">${
item.description
}</p>
                </div>
            </div>
        `;
suggestionsRow.insertAdjacentHTML('beforeend', suggCard);
});
}

// 2. Display Jobs
if (data.jobs && data.jobs.length > 0) {
jobsSection.style.display = 'block';
data.jobs.forEach((job, index) => {
const isPremium = job.match_score > 85;
const card = `
            <div class="col-lg-4 mb-4" data-aos="fade-up" data-aos-delay="${
(index + 3) * 100
}">
                <div class="glass-card h-100 ${
isPremium ? 'premium-border' : ''
}">
                    ${
isPremium ? '<span class="position-absolute top-0 end-0 mt-3 me-3 badge bg-danger">TOP MATCH</span>' : ''
}
                    <div class="match-score">${
job.match_score
}%</div>
                    <h3 class="job-title" style="font-size: 1.25rem;">${
job.title
}</h3>
                    <div class="job-details">
                        <p class="mb-1"><i class="bi bi-building"></i> ${
job.company
}</p>
                        <p class="mb-1"><i class="bi bi-geo-alt"></i> ${
job.location
}</p>
                        <p class="mb-3"><i class="bi bi-cash-stack"></i> ${
job.salary || 'Sur demande'
}</p>
                    </div>
                    <p class="opacity-75 small mb-4" style="color: var(--color-steel-blue); min-height: 60px;">
                        ${
job.description.substring(0, 120)
}...
                    </p>
                    <a href="${
job.url
}" target="_blank" class="btn btn-apply">
                        Voir l'Offre <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        `;
jobsRow.insertAdjacentHTML('beforeend', card);
});

// Init Map with coordinates
initMap(data.jobs);
} else {
jobsSection.style.display = 'block';
jobsRow.innerHTML = `<div class="col-12 text-center py-5"><h4 class="text-white">Aucune offre trouvée.</h4></div>`;
}

// Re-init AOS
if (typeof AOS !== 'undefined') 
AOS.refresh();



}).catch(error => {
console.error('Erreur Analyse:', error);
loading.style.display = 'none';
startBtn.disabled = false;
startBtn.innerHTML = 'Réessayer';
jobsRow.innerHTML = `<div class="col-12 text-center text-danger"><p>Une erreur est survenue : ${
error.message
}</p></div>`;
jobsSection.style.display = 'block';
});
});
</script>{% endblock %}
